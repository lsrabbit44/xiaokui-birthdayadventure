<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å°è‘µçš„ç”Ÿæ—¥å¤§å†’é™© - V52.9(æœ€ç»ˆå®Œç¾åº†å…¸ç‰ˆ)</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { background-color: #111; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: white; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; user-select: none; }
        #game-container { position: relative; width: 800px; height: 600px; box-shadow: 0 0 50px rgba(0,0,0,0.8); border: 4px solid #555; background-color: #000; image-rendering: pixelated; }
        canvas { display: block; width: 100%; height: 100%; outline: none; }
        .hidden { display: none !important; }
        .pixel-btn { background: #ff6b6b; border: 4px solid #800000; color: white; padding: 10px 15px; font-family: 'Courier New', monospace; font-size: 16px; cursor: pointer; margin: 5px; display: inline-block; }
        .pixel-btn:active { transform: translate(2px, 2px); }
        .pixel-btn.start { background: #51cf66; border-color: #1e5c2b; }
        
        /* äº¤äº’æç¤º */
        #interact-hint { position: absolute; bottom: 80px; width: 100%; text-align: center; font-size: 20px; color: #fff; text-shadow: 2px 2px 0 #000; animation: pulse 1s infinite; z-index: 45; pointer-events: none; display: none; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* æ‰‹æœº & UI */
        #phone-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 340px; height: 600px; background: #f0f0f0; border: 8px solid #333; border-radius: 10px; display: none; flex-direction: column; z-index: 100; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,0.6); }
        #phone-header { background: #333; color: #eee; padding: 15px; text-align: center; font-size: 18px; border-bottom: 4px solid #111; min-height: 25px; font-family: monospace; }
        #phone-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .msg-row { display: flex; margin-bottom: 15px; opacity: 0; animation: slideIn 0.3s forwards; }
        .msg-row.me { justify-content: flex-end; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .avatar-img { width: 40px; height: 40px; border: 2px solid #000; margin-right: 10px; object-fit: cover; background: #ff99cc; }
        .bubble { background: #fff; color: #000; padding: 12px; border: 2px solid #000; max-width: 200px; font-size: 18px; line-height: 1.4; }
        .msg-row.me .bubble { background: #a0e0ff; }
        #phone-footer { padding: 10px; background: #ccc; border-top: 4px solid #333; text-align: center; min-height: 60px; display: flex; justify-content: center; align-items: center;}
        
        #dialog-box { position: absolute; bottom: 20px; left: 20px; right: 20px; background: rgba(0, 0, 0, 0.9); border: 4px solid #fff; padding: 20px; z-index: 50; color: white; font-size: 20px; line-height: 1.5; }
        #dialog-name { color: #ffd700; font-size: 24px; margin-bottom: 10px; font-weight: bold; }
        #task-bar { position: absolute; top: 20px; width: 100%; text-align: center; color: #0f0; font-family: 'Courier New', monospace; font-size: 24px; text-shadow: 2px 2px 0 #000; z-index: 40; pointer-events: none; display: none; animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        #safe-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 260px; background: #333; border: 6px solid #888; padding: 20px; z-index: 70; display: none; flex-direction: column; align-items: center; }
        #safe-screen { width: 100%; background: #000; color: #0f0; font-family: monospace; font-size: 24px; text-align: center; padding: 10px 0; margin-bottom: 10px; border: 2px solid #555; }
        #safe-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 100%; }
        .safe-btn { background: #555; border: 2px solid #222; color: white; padding: 10px; text-align: center; cursor: pointer; font-weight: bold; font-family: monospace; font-size: 20px; }
        .safe-btn:active { background: #777; }
        
        #quiz-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; background: #222; border: 6px solid #ffd700; padding: 20px; z-index: 60; display: none; flex-direction: column; box-shadow: 10px 10px 0 rgba(0,0,0,0.5); font-family: 'Courier New', monospace; }
        #quiz-title { text-align: center; color: #ffd700; font-size: 24px; margin-bottom: 20px; border-bottom: 2px dashed #555; padding-bottom: 10px; }
        #quiz-question { color: white; font-size: 20px; margin-bottom: 20px; line-height: 1.4; min-height: 30px; }
        #quiz-options { display: flex; flex-direction: column; gap: 10px; }
        .quiz-option-btn { background: #444; border: 2px solid #777; color: white; padding: 15px; text-align: left; cursor: pointer; font-family: inherit; font-size: 18px; }
        .quiz-option-btn:hover { background: #666; border-color: #fff; }
        
        #transition-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 200; display: none; color: white; justify-content: center; align-items: center; flex-direction: column; }
        .loader { border: 8px solid #333; border-top: 8px solid #fff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- æŠ“å¨ƒå¨ƒæœº --- */
        #claw-machine { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; height: 420px; background: #ffccff; border: 8px solid #ff66b2; z-index: 80; display: none; flex-direction: column; overflow: hidden; box-shadow: 0 0 0 1000px rgba(0,0,0,0.8); }
        #claw-header { height: 40px; background: #ff66b2; color: white; text-align: center; line-height: 40px; font-weight: bold; font-size: 20px; }
        #claw-instruction { background: #fff9c4; color: #d32f2f; text-align: center; font-size: 14px; padding: 5px; font-weight: bold; border-bottom: 2px solid #ff66b2; }
        #claw-area { flex: 1; position: relative; background: #fff0f5; overflow: hidden; border-bottom: 4px solid #ff66b2; }
        #claw-assembly { position: absolute; top: 0; left: 20px; width: 40px; height: 300px; transition: height 0.5s; }
        #claw-rod { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 100%; background: #555; }
        #claw-hub { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 24px; height: 16px; background: #333; border-radius: 4px; z-index: 2; }
        .claw-finger { position: absolute; bottom: -20px; width: 16px; height: 30px; border: 4px solid #555; border-top: none; z-index: 1; }
        #claw-left { left: -8px; border-right: none; border-radius: 0 0 0 20px; transform: rotate(15deg); transform-origin: top right; }
        #claw-right { right: -8px; border-left: none; border-radius: 0 0 20px 0; transform: rotate(-15deg); transform-origin: top left; }
        .doll { position: absolute; bottom: 10px; font-size: 40px; width: 50px; text-align: center; transition: left 0.5s linear; }
        #claw-controls { height: 80px; background: #eee; display: flex; justify-content: space-around; align-items: center; padding: 0 20px; }
        .machine-btn { width: 80px; height: 50px; border-radius: 50%; font-weight: bold; border: 4px solid rgba(0,0,0,0.2); cursor: pointer; font-size: 18px; color: white; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .machine-btn:active { transform: translateY(4px); box-shadow: none; }
        #claw-status { position: absolute; top: 75px; right: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 14px; z-index: 10; }

        /* æ‰“åœ°é¼  */
        #mole-machine { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 460px; height: 500px; background: #f0ad4e; border: 8px solid #d9534f; z-index: 81; display: none; flex-direction: column; box-shadow: 0 0 0 1000px rgba(0,0,0,0.8); }
        #mole-header { height: 60px; background: #d9534f; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; color: white; font-size: 24px; font-family: monospace; font-weight: bold; }
        #mole-grid { flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; background: #8b4513; }
        .mole-hole { background: #3e2723; border-radius: 50%; position: relative; overflow: hidden; border: 4px solid #5d4037; cursor: pointer;}
        .mole-hole::after { content:''; display:block; padding-bottom: 100%; }
        .mole-sprite { position: absolute; bottom: -100%; left: 15%; width: 70%; height: 80%; border-radius: 40% 40% 0 0; transition: bottom 0.1s; display: flex; justify-content: center; align-items: center; font-size: 40px; }
        .mole-sprite.up { bottom: 0; }
        .mole-orange { background: #ff8c00; border: 2px solid #fff; }
        .mole-yellow { background: #ffd700; border: 2px solid #ff0000; }
        #mole-start-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index: 10; font-size: 20px; text-align: center; }

        /* å¤§ç»“å±€ UI */
        #prize-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 150; display: none; flex-direction: column; justify-content: center; align-items: center; color: #ffd700; }
        #prize-container { width: 300px; height: 300px; border: 10px solid #fff; background: #333; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 100px #ffd700; margin-bottom: 30px; animation: float 3s infinite ease-in-out; overflow: hidden;}
        #prize-container img { width: 100%; height: 100%; object-fit: cover; }
        #prize-placeholder { font-size: 150px; }
        @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0); } }
        
        /* å¹»ç¯ç‰‡ */
        #slideshow-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 180; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .slide-frame { width: 640px; height: 480px; border: 20px solid #eee; background: #222; position: relative; display: flex; justify-content: center; align-items: center; font-family: 'Courier New', monospace; text-align: center; overflow: hidden;}
        .slide-img-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .slide-img-container img { width: 100%; height: 100%; object-fit: contain; }
        .slide-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 50px; height: 50px; background: rgba(255,255,255,0.3); color: white; font-size: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 50%; user-select: none; z-index: 10; }
        .slide-btn:hover { background: rgba(255,255,255,0.6); }
        .slide-btn.prev { left: 10px; }
        .slide-btn.next { right: 10px; }
        .slide-finish-btn { margin-top: 20px; background: #ff4081; color: white; padding: 10px 20px; cursor: pointer; font-size: 16px; font-family: monospace; border: 2px solid #fff; }
        
        #input-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; background: rgba(0,0,0,0.95); border: 4px solid #fff; padding: 30px; z-index: 190; display: none; flex-direction: column; align-items: center; text-align: center; }
        #user-input { background: #333; color: white; border: 2px solid #888; padding: 10px; width: 80%; font-size: 20px; font-family: monospace; margin: 20px 0; outline: none; }
        
        /* V59: ä¿¡ä»¶ UI */
        #letter-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #letter-container { max-width: 600px; max-height: 500px; overflow: hidden; border: 10px solid #fff; box-shadow: 0 0 50px rgba(255,255,255,0.5); }
        #letter-container img { width: 100%; height: auto; display: block; }
        
        #fireworks-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 90; pointer-events: none; display: none; }
        #bgm-indicator { position: absolute; top: 10px; right: 10px; color: #0f0; font-family: monospace; z-index: 100; display: none; text-shadow: 0 0 5px #0f0; }
        #end-game-btn { position: absolute; bottom: 20px; right: 20px; z-index: 200; display: none; padding: 10px; background: #333; border: 2px solid #fff; cursor: pointer; font-family: monospace; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="800" height="600" tabindex="-1"></canvas>
    <canvas id="fireworks-canvas" width="800" height="600"></canvas>
    
    <audio id="bgm" src="bgm.mp3" loop></audio>
    <audio id="claw-bgm" src="claw_bgm.mp3" loop></audio>
    <audio id="mole-bgm" src="mole_bgm.mp3" loop></audio>
    <audio id="hit-sfx" src="hit.mp3"></audio>
    <audio id="claw-drop-sfx" src="claw_drop.mp3"></audio>
    <audio id="win-sfx" src="win.mp3"></audio>
    <audio id="dog-bark-sfx" src="dog_bark.mp3"></audio>
    <audio id="slide-bgm" src="piano.mp3"></audio>
    <audio id="piano2" src="piano2.mp3"></audio> <audio id="firework-sfx" src="firework.mp3"></audio>
    
    <div id="phone-overlay"><div id="phone-header"></div><div id="phone-messages"></div><div id="phone-footer"></div></div>
    <div id="dialog-box" class="hidden"><div id="dialog-name"></div><div id="dialog-text"></div></div>
    
    <div id="interact-hint">æŒ‰ç©ºæ ¼é”® [SPACE] è°ƒæŸ¥ç‰©å“</div>
    <div id="task-bar"></div>
    
    <div id="safe-ui"><div id="safe-screen">----</div><div id="safe-pad"></div><div class="pixel-btn" style="margin-top:15px; background:#c00; width:120px; text-align:center;" onclick="closeSafe()">å…³é—­</div></div>
    <div id="quiz-ui"><div id="quiz-title"></div><div id="quiz-question"></div><div id="quiz-options"></div></div>
    <div id="transition-overlay"><div class="loader"></div><div style="margin-top:20px; font-family:monospace;">LOADING...</div></div>

    <div id="claw-machine">
        <div id="claw-header">å…¨èŒé«˜æ‰‹é™å®šæŠ“æŠ“ä¹</div>
        <div id="claw-instruction">ğŸ’¡ æŠ“åˆ° 3 åªç‹ç‹¸å³å¯è§£é”ã€æ‰“åœ°é¼ æœºã€‘ï¼</div>
        <div id="claw-status">ç›®æ ‡ï¼šğŸ¦Š x <span id="claw-score">0</span>/3</div>
        <div id="claw-area">
            <div id="claw-assembly">
                <div id="claw-rod"></div>
                <div id="claw-hub"></div>
                <div id="claw-left" class="claw-finger"></div>
                <div id="claw-right" class="claw-finger"></div>
            </div>
            <div id="dolls-container"></div>
        </div>
        <div id="claw-controls">
            <div style="font-size:14px; color:#555;">â† çˆªå­ä¼šè‡ªåŠ¨ç§»åŠ¨ â†’</div>
            <div class="machine-btn" style="background:#ff4081;" onclick="clawGame.drop()">æŠ“ï¼</div>
            <div class="machine-btn" style="background:#999;" onclick="clawGame.close()">é€€å‡º</div>
        </div>
    </div>

    <div id="mole-machine">
        <div id="mole-header">
            <div>TIME: <span id="mole-time">30</span></div>
            <div>SCORE: <span id="mole-score">0</span>/10</div>
        </div>
        <div id="mole-grid">
            <div class="mole-hole" id="hole0"></div><div class="mole-hole" id="hole1"></div><div class="mole-hole" id="hole2"></div>
            <div class="mole-hole" id="hole3"></div><div class="mole-hole" id="hole4"></div><div class="mole-hole" id="hole5"></div>
            <div class="mole-hole" id="hole6"></div><div class="mole-hole" id="hole7"></div><div class="mole-hole" id="hole8"></div>
        </div>
        <div id="mole-start-overlay">
            <p>ç›®æ ‡ï¼š30ç§’å†…æ‰“10ä¸ªæ©˜è‰²åœ°é¼ (ğŸŸ )</p>
            <p style="color:#ffd700; font-size:16px;">æ³¨æ„ï¼šä¸è¦æ‰“é»„è‰²åœ°é¼ (ğŸŸ¡)ï¼</p>
            <div class="pixel-btn start" style="margin-top:20px;" onclick="moleGame.start()">å¼€å§‹æ¸¸æˆ</div>
            <div class="pixel-btn" style="margin-top:10px; background:#999;" onclick="moleGame.close()">ç¦»å¼€</div>
        </div>
    </div>

    <div id="prize-overlay">
        <div style="font-size:30px; margin-bottom:20px; color:#fff;">â˜… SUPER JACKPOT â˜…</div>
        <div id="prize-container">
            <img src="prize.png" alt="prize.png" onerror="this.style.display='none'; document.getElementById('prize-placeholder').style.display='block';">
            <div id="prize-placeholder" style="display:none;">ğŸ</div>
        </div>
        <div style="font-size:24px; color:#ccc;">è·å¾—ã€é™é‡æ¬¾å¶ä¿®å¨ƒå¨ƒå‘¨è¾¹ã€‘</div>
        <div class="pixel-btn start" style="margin-top:40px;" onclick="hidePrize()">[ ç‚¹å‡»ç¡®è®¤ ]</div>
    </div>

    <div id="slideshow-overlay">
        <div class="slide-frame">
            <div class="slide-btn prev" onclick="changeSlide(-1)">&#10094;</div>
            <div class="slide-btn next" onclick="changeSlide(1)">&#10095;</div>
            <div class="slide-img-container">
                <img id="slide-img-dom" src="" alt="slideX.png" onerror="this.style.display='none'; document.getElementById('slide-text-fallback').style.display='block';">
                <div id="slide-text-fallback" style="display:none; color:white; font-size:20px; padding:20px;">
                    <span id="slide-text-content"></span>
                </div>
            </div>
            <div id="slide-icon" class="slide-deco"></div>
        </div>
        <div class="slide-finish-btn" onclick="finishSlideshow()">[ è·³è¿‡ / å®Œæˆå›å¿† ]</div>
    </div>

    <div id="input-overlay">
        <div style="font-size:24px; color:#ffd700;">ç”Ÿæ—¥å¿«ä¹ï¼ä½ æœ‰ä»€ä¹ˆè¯æƒ³è¯´ï¼Ÿ</div>
        <input type="text" id="user-input" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..." autocomplete="off">
        <div class="pixel-btn start" onclick="submitFinalMsg()">å‘é€</div>
    </div>
    
    <div id="letter-overlay">
        <div id="letter-container">
            <img src="letter.png" alt="letter">
        </div>
        <div class="pixel-btn start" style="margin-top:20px;" onclick="closeLetter()">[ æ”¶èµ·ä¿¡ä»¶ ]</div>
    </div>
    
    <div id="bgm-indicator">â™ª BGM: Glory - åŠé“è‹±é›„ â™ª</div>
    <div id="end-game-btn" onclick="location.reload()">é€€å‡º / é‡æ–°å¼€å§‹</div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 800; canvas.height = 600;
    ctx.imageSmoothingEnabled = false;

    // V59: éŸ³é‡å¹³è¡¡ (BGM 0.3)
    window.onload = function() {
        const bgmIds = ['bgm', 'claw-bgm', 'mole-bgm'];
        bgmIds.forEach(id => { const el = document.getElementById(id); if(el) el.volume = 0.2; }); 
        
        const loudIds = ['slide-bgm', 'piano2']; 
        loudIds.forEach(id => { const el = document.getElementById(id); if(el) el.volume = 1.0; });
    };

    // å…¨å±€çŠ¶æ€
    let gameState = "PHONE"; 
    let currentScene = "BEDROOM";
    let flags = {
        phonePhase: 0, 
        dogFound: false, dogJoined: false,
        hallMeetLizi: false, coinCount: 0,
        quizPassed: false,
        clawPassed: false, moleUnlocked: false, molePassed: false,
        finalPhase: false, dogFollowsYeXiu: false,
        hasInteracted: false
    };
    let allowMainBgm = true;

    const player = { x: 130, y: 220, w: 32, h: 48, color: "#ff3333", speed: 5 };
    const dog = { x: 0, y: 0, w: 32, h: 32, color: "#ffd700", visible: false };
    const lizi = { x: 350, y: 500, w: 32, h: 48, color: "#ff99cc", visible: false };
    
    const scenes = {
        BEDROOM: {
            bg: "#2b2b2b",
            objects: [
                {name:"rug", x:320, y:250, w:150, h:125, color:"#444", label:"åœ°æ¯¯", text:"åœ°æ¯¯ä¸Šæ˜¯ä¸æ˜¯å¯ä»¥èººä¸€ä¼šå„¿...å¯¹äº†ï¼Œå°ç‹—æ²¡æœ‰å°¿åœ¨è¿™é‡Œå§ã€‚", noDog:"åœ°æ¯¯ä¸‹é¢æ²¡æœ‰ï¼Œä¸è¿‡å¥½åƒæœ‰æ ¹ç‹—æ¯›..."},
                {name:"window", x:335, y:20, w:130, h:78, color:"#87ceeb", label:"çª—æˆ·", text:"(æ‹‰å¼€çª—å¸˜) ä»Šå¤©å¤©æ°”å¥½æ™´æœ—ï¼Œé€‚åˆçªåœ¨å®¶æ‰“æ¸¸æˆã€‚", noDog:"çª—å¸˜åé¢ä¹Ÿæ²¡æœ‰è—ç€å°ç‹—ã€‚"},
                {name:"bed", x:100, y:100, w:90, h:138, color:"#5d9cec", label:"åºŠ", text:"å¥½æƒ³å†å›å»ç¡ä¼šå„¿å‘€...ä¸è¡Œï¼å°æ —å­è¿˜åœ¨ç­‰æˆ‘ï¼", noDog:"è¢«å­é‡Œæœ‰ä¸€å›¢å‡¸èµ·ï¼Œæ€å¼€ä¸€çœ‹æ˜¯æ•å¤´ã€‚å°ç‹—ä¸åœ¨åºŠä¸Šã€‚"},
                {name:"bookshelf", x:510, y:80, w:80, h:150, color:"#d2691e", label:"ä¹¦æ¶", text:"åä¹‰ä¸Šæ˜¯ä¹¦æ¶ï¼Œå®é™…ä¸Šæ˜¯è°·æ¶ã€‚å¥½å‡ æ¬¾å¶ä¿®å·²ç»ç»ç‰ˆäº†ã€‚", noDog:"ä¹¦æ¶ç¼éš™é‡Œä¹Ÿæ²¡æœ‰...å®ƒé‚£ä¹ˆèƒ–ä¹Ÿé’»ä¸è¿›å»å§ã€‚"},
                {name:"desk", x:600, y:100, w:125, h:100, color:"#8a6d3b", label:"ç”µè„‘æ¡Œ"}, 
                {name:"wardrobe", x:80, y:350, w:100, h:150, color:"#8b4513", label:"è¡£æŸœ", text:"è¡£æŸœæ²¡æ”¶æ‹¾ï¼Œæœ‰ä¸€åŠå †çš„æ˜¯æˆ‘å’Œå¶ä¿®çš„é˜Ÿæœã€‚", noDog:"è¿™é‡Œè²Œä¼¼æ²¡æœ‰æ¯›èŒ¸èŒ¸çš„å°è„‘è¢‹ã€‚"},
                {name:"vanity", x:200, y:100, w:50, h:100, color:"#ffb6c1", label:"åŒ–å¦†å°", text:"èµ¶æ—¶é—´ä¸åŒ–å¦†äº†...", noDog:"æ¡Œåº•ä¸‹æ˜¯ç©ºçš„ï¼Œåªæœ‰æˆ‘çš„æ‹–é‹ã€‚"},
                {name:"safe", x:650, y:450, w:50, h:50, color:"#777", label:"ä¿é™©ç®±"}, 
                {name:"door", x:350, y:580, w:100, h:20, color:"#111", label:"å‡ºé—¨"}
            ]
        },
        HALL: {
            bg: "#1e1e2e",
            objects: [ 
                {name:"door", x:350, y:580, w:100, h:20, color:"#444", label:"å›å§å®¤"},
                {name:"counter", x:322, y:50, w:156, h:78, color:"#555", label:"æŸœå°"},
                {name:"clerk", x:380, y:80, w:40, h:48, color:"#fff", label:"åº—å‘˜"},
                {name:"claw", x:150, y:120, w:100, h:100, color:"#ff00ff", label:"æŠ“å¨ƒå¨ƒæœº"},
                {name:"mole", x:550, y:120, w:100, h:100, color:"#ff4500", label:"æ‰“åœ°é¼ æœº"},
                {name:"dance", x:100, y:350, w:78, h:100, color:"#e0e", label:"è·³èˆæœº", text:"è·³èˆæœºï¼Œçœ‹ä¸‹æ­Œå•é‡Œæœ‰æ²¡æœ‰é‡èœ‚é£èˆã€‚"},
                {name:"basket", x:200, y:350, w:78, h:100, color:"#fa0", label:"æŠ•ç¯®æœº", text:"æ„Ÿè§‰æˆ‘åœ¨è¿™ä¸ªé¡¹ç›®ä¸Šèƒ½èµ¢è¿‡å¶ä¿®ï¼Œå˜¿å˜¿ã€‚"},
                {name:"coin", x:500, y:360, w:65, h:78, color:"#0ff", label:"æ¨å¸æœº", text:"è¿™ä¹ˆå¤šé‡‘å¸å•Š......åƒæ˜¯é­ç›å‰è¾ˆå–œæ¬¢ç©çš„ã€‚"},
                {name:"arcade", x:580, y:360, w:65, h:78, color:"#0f0", label:"è¡—éœ¸", text:"å¥½å¤æ—©çš„æ¸¸æˆæœºã€‚æ‹³çš‡äº‰éœ¸ï¼Ÿè¯¯å…¥éŸ©é˜Ÿçš„ç»Ÿæ²»åŒºäº†ã€‚"},
                {name:"gun", x:660, y:360, w:65, h:78, color:"#32cd32", label:"å°„å‡»", text:"ä¸çŸ¥é“èŒä¸šé€‰æ‰‹åœ¨è¿™é‡Œèƒ½ä¸èƒ½ç”¨ä¸ŠæŠ¼æªæŠ€å·§ã€‚"},
                {name:"lizi_npc", x:50, y:150, w:32, h:48, color:"#ff99cc", label:"å°æ —å­"}, 
                {name:"yexiu", x:380, y:200, w:36, h:52, color:"#000", label:"å¶ä¿®", visible:false},
                {name:"cake", x:350, y:360, w:100, h:100, color:"#ff99cc", label:"", visible:false}
            ]
        }
    };

    const dialogs = {
        desk_full: [{n:"å°è‘µ",t:"ç”µè„‘æ¡Œä¸‹é¢æ²¡æœ‰å°ç‹—ï¼Œèº²å“ªå„¿å»äº†ï¼Ÿ"}, {n:"å°è‘µ",t:"ç”µè„‘å¼€ç€ï¼Œæ˜¨æ™šçš„è£è€€æ¯”èµ›è¿˜æ²¡çœ‹å®Œ...è¯´èµ·æ¥ï¼Œå¶ä¿®äººå‘¢ï¼Ÿ"}],
        safe_locked: [{n:"ä¿é™©ç®±",t:"æ²¡æœ‰å¯†ç æˆ‘æ˜¯ä¸ä¼šå¼€çš„ã€‚"}],
        dog_found: [{n:"å°ç‹—",t:"æ±ªï¼(è½¬åœˆåœˆ)"},{n:"å°è‘µ",t:"å•Šå•Šå•Šå•Šå°ç‹—ï¼Œä½ æ€ä¹ˆå’Œå¶ä¿®çš„é“¶è¡Œå¡ç¡åˆ°ä¸€èµ·å»äº†ï¼Ÿå¿«å‡ºæ¥ï¼"},{n:"ç³»ç»Ÿ",t:"ã€å°ç‹—ã€‘åŠ å…¥äº†é˜Ÿä¼ã€‚"},{n:"ç³»ç»Ÿ",t:"ï¼ˆè®°å¾—çœ‹ä¸€çœ¼æ‰‹æœºï¼Œç»™å°æ —å­å›ä¸ªä¿¡ï¼‰"}],
        safe_empty: [{n:"å°è‘µ",t:"é‡Œé¢åªå‰©ä¸‹å¶ä¿®çš„é“¶è¡Œå¡äº†ï¼Œè¿˜æ˜¯åˆ«åŠ¨äº†ã€‚"}],
        door_locked: [{n:"å°è‘µ",t:"ä¸è¡Œï¼Œæˆ‘å¾—å¸¦ä¸Šå°ç‹—ï¼Œä¸ç„¶å°æ —å­ä¼šæ€¥å“­çš„ã€‚"}],
        hall_meet: [{n:"å°æ —å­",t:"ç»ˆäºæ¥å•¦ï¼Œå°ç‹—ä¹Ÿåœ¨ï¼èµ°ï¼Œæˆ‘ä»¬å»æ¢å¸ï¼"},{n:"ç³»ç»Ÿ",t:"ã€å°æ —å­ã€‘åŠ å…¥é˜Ÿä¼ã€‚"}],
        clerk_buy: [
            {n:"åº—å‘˜",t:"ä¸‰ä½å¥½ï¼Œæ¬¢è¿å…‰ä¸´æˆ‘ä»¬çš„æ¸¸æˆå…ã€‚è¯·é—®ä½ ä»¬éœ€è¦å¤šå°‘æšæ¸¸æˆå¸ï¼Ÿ"},
            {n:"å°è‘µ",t:"è¦ä¸â€¦å…ˆæ¥200ä¸ªï¼Ÿåº”è¯¥å¤Ÿç©ä¸€é˜µå§ã€‚"},
            {n:"åº—å‘˜",t:"å¥½çš„ï¼Œé‚£ä¸€å…±æ˜¯20ç‹—ç‹—å¸å“¦ã€‚"},
            {n:"å°è‘µ",t:"gogoå¸ï¼Œé‚£æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿç°é‡‘æ”¯ä»˜å¯ä»¥å˜›ï¼Ÿ"},
            {n:"åº—å‘˜",t:"(æŒ‡äº†æŒ‡èº«åçš„ç‰Œå­)è¿™é‡Œæ˜¯ç‹—ç‹—æ¸¸æˆå…ï¼Œæˆ‘ä»¬åªæ”¶å–ç‹—ç‹—å¸å“¦ã€‚"},
            {n:"å°è‘µ",t:"(å®Œäº†ï¼Œæˆ‘ä»¬æ˜¯ä¼ é€è¿‡æ¥çš„ï¼Œæ²¡æœ‰çœ‹åˆ°ç‰Œå­)"},
            {n:"å°æ —å­",t:"é‚£æ€ä¹ˆåŠæâ€¦å°ç‹—å°ç‹—ï¼Œä½ å¿«æƒ³åŠæ³•å‘€ï¼"},
            {n:"å°ç‹—",t:"æ±ªæ±ªï¼(æ€¥å¾—å’¬è‡ªå·±å°¾å·´)"},
            {n:"åº—å‘˜",t:"å“‡ï¼Œå¥½å¬è¯çš„ç‹—ç‹—ï¼ç™½è‰²çš„æŸ´çŠ¬è„¾æ°”è¿™ä¹ˆå¥½ï¼Ÿæ¥ï¼Œè¿™æšæ¸¸æˆå¸ç»™ä½ ã€‚"},
            {n:"å°ç‹—",t:"æ±ªæ±ªï¼(è°¢è°¢ï¼)"},
            {n:"ç³»ç»Ÿ",t:"è·å¾—ã€æ¸¸æˆå¸ã€‘x1"},
            {n:"åº—å‘˜",t:"å¥½å§ï¼Œå…¶å®æˆ‘ä»¬æœ‰ä¸€ä¸ªè£è€€ç²‰é™å®šæ´»åŠ¨ï¼Œç­”å¯¹å…³äºè£è€€çš„é—®é¢˜è¿˜å¯ä»¥è·å–æ¸¸æˆå¸ï¼ä¸è¿‡æ¯äººæœ€å¤šæ‹¿ä¸€ä¸ªå“¦ã€‚"},
            {n:"å°è‘µ",t:"(å¤ªå¥½äº†ï¼Œè¿™æ ¹æœ¬ä¸éš¾)è°¢è°¢ä½ å‘Šè¯‰æˆ‘ä»¬ï¼é‚£ä¹ˆï¼Œè¯·å¼€å§‹æé—®å§ã€‚"},
            {n:"å°æ —å­",t:"å¥½è€¶ï¼Œé—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"} 
        ],
        lizi_quiz_wrong: [{n:"å°æ —å­",t:"å¥³ç¥ä¿ä½‘ï¼é€‰cï¼"},{n:"åº—å‘˜",t:"...é”™ï¼Œä½†æ˜¯å†ç»™ä½ ä»¬ä¸€æ¬¡æœºä¼šå§ã€‚"}],
        quiz_pass: [{n:"å°è‘µ",t:"æ•£äººï¼"},{n:"åº—å‘˜",t:"å›ç­”æ­£ç¡®ï¼Œæ­å–œæ­å–œï¼ŒçœŸä¸å®¹æ˜“ï¼ç°åœ¨å¯ä»¥å»ç©æŠ“å¨ƒå¨ƒèµ¢æˆ‘ä»¬ä»Šå¤©çš„å¤§å¥–å•¦(é€’è¿‡æ¥ä¸¤æšæ¸¸æˆå¸)ã€‚"},{n:"ç³»ç»Ÿ",t:"è·å¾—ã€æ¸¸æˆå¸ã€‘x2ã€‚ç°æœ‰ï¼š3æšã€‚æŠ“å¨ƒå¨ƒæœºè§£é”ï¼"}],
        hall_lock_claw: [{n:"ç³»ç»Ÿ",t:"ã€æç¤ºã€‘å…ˆå»ç©æŠ“å¨ƒå¨ƒæœºèµ¢å–å¥–å“ï¼"}],
        claw_win: [{n:"å°æ —å­",t:"å“‡ï¼æ˜¯é™é‡ç‰ˆçš„ç‹ç‹¸ï¼å¥½å‰å®³ï¼"}, {n:"ç³»ç»Ÿ",t:"ã€æ‰“åœ°é¼ æœºã€‘å·²è§£é”ï¼å»è¯•è¯•èº«æ‰‹å§ï¼"}],
        finale_1: [{n:"å°è‘µ",t:"è¶…çº§å¤§å¥–å±…ç„¶æ˜¯è¿™ä¸ªï¼å°æ —å­ï¼Œä½ æ˜¯ä¸æ˜¯æ—©å°±çŸ¥é“ï¼Ÿ"},{n:"å°ç‹—",t:"æ±ªæ±ªï¼Œæ±ªæ±ªæ±ªï¼ï¼ˆå¯¹å•Šï¼Œç’ç€ä½ ï¼‰"}],
        finale_2: [{n:"å¶ä¿®",t:"å°å®¶ä¼™æ‰‹é€Ÿå¯ä»¥å•Šã€‚æœ‰å…´è¶£å‚åŠ æˆ‘ä»¬æ‰“åœ°é¼ èŒä¸šè”ç›Ÿèµ›å—ï¼Ÿ"},{n:"å°è‘µ",t:"(æƒŠ!)  æˆ‘ä¸€å¤§æ—©éƒ½æ²¡æœ‰è§åˆ°ä½ ï¼Œå¶ä¿®ï¼Œä½ å»å“ªé‡Œäº†ï¼Ÿ"},{n:"å°ç‹—",t:"æ±ªæ±ªï¼Ÿï¼ˆè‘µä½ è¿™ä¸ªå®¶ä¼™å‹æ ¹æ²¡æœ‰æ—©ä¸Šèµ·åºŠå§ï¼‰"},{n:"å¶ä¿®",t:"ï¼ˆæ‹›æ‰‹ï¼‰å°ç‹—ï¼Œè¿‡æ¥ã€‚"}],
        finale_3_tape: [{n:"ç³»ç»Ÿ",t:"å°ç‹—ä¸å†è·Ÿéšå°è‘µã€‚"},{n:"ç³»ç»Ÿ",t:"å°ç‹—ä»å¶ä¿®é‚£é‡Œå¼è¿‡æ¥ä¸€ç›˜å½•åƒå¸¦ã€‚"},{n:"å°è‘µ",t:"(æ¥è¿‡å½•åƒå¸¦) è¿™æ˜¯..."}],
        finale_4_happy: [{n:"å¶ä¿®",t:"(ç¬‘) ç”Ÿæ—¥å¿«ä¹ï¼Œæˆ‘çš„å¥³ä¸»è§’ã€‚"},{n:"å°æ —å­ & å°ç‹—",t:"å°è‘µï¼Œç”Ÿæ—¥å¿«ä¹ï¼ˆæ±ªæ±ªæ±ªæ±ªï¼‰ï¼ï¼ï¼"}]
    };

    // V59: çº¯å›¾ Slide
    const slideData = [
        {img: "slide1.png"},
        {img: "slide2.png"},
        {img: "slide3.png"},
        {img: "slide4.png"},
        {img: "slide5.png"},
        {img: "slide6.png"},
        {img: "slide7.png"}
    ];

    function preloadAssets(cb) { setTimeout(cb, 100); }
    
    const imgCache = {};
    const imgSources = [
        'player.png','dog.png','lizi.png','prize.png', 'lizi_avatar.png',
        'bg_bedroom.png', 'bed.png', 'desk.png', 'vanity.png', 
        'wardrobe.png', 'bookshelf.png', 'rug.png', 'safe.png', 'window.png',
        'bg_hall.png', 'counter.png', 'clerk.png', 
        'mole.png', 'claw.png', 
        'dance.png', 'basket.png', 
        'coin.png', 'arcade.png', 'gun.png',
        'yexiu.png', 'cake.png', 'letter.png' 
    ];
    imgSources.forEach(src => { const i = new Image(); i.src = src; i.onload=()=>{imgCache[src]=i;}; });

    function drawSprite(name, x, y, w, h, c) {
        const map = {
            'bed': 'bed.png', 'desk': 'desk.png', 'vanity': 'vanity.png',
            'wardrobe': 'wardrobe.png', 'bookshelf': 'bookshelf.png', 'rug': 'rug.png',
            'safe': 'safe.png', 'window': 'window.png', 'player': 'player.png',
            'dog': 'dog.png', 'lizi': 'lizi.png', 'lizi_npc': 'lizi.png',
            'counter': 'counter.png', 'clerk': 'clerk.png', 'mole': 'mole.png',
            'claw': 'claw.png', 'dance': 'dance.png', 'basket': 'basket.png',
            'coin': 'coin.png', 'arcade': 'arcade.png', 'gun': 'gun.png',
            'yexiu': 'yexiu.png', 'cake': 'cake.png'
        };

        if(map[name] && imgCache[map[name]]) {
            ctx.drawImage(imgCache[map[name]], x, y, w, h);
        } else {
            ctx.fillStyle = c || '#f0f'; ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = "rgba(0,0,0,0.3)"; ctx.strokeRect(x, y, w, h);
            if(name==='yexiu') { ctx.fillStyle="#fff"; ctx.font="12px monospace"; ctx.fillText("ğŸš¬", x+10, y+10); }
        }
    }

    function playAudio(id) { const a=document.getElementById(id); if(a){a.currentTime=0; a.play().catch(e=>{});} }
    function stopAudio(id) { const a=document.getElementById(id); if(a){a.pause(); a.currentTime=0;} }
    
    function tryPlayBgm() { 
        const bgm=document.getElementById('bgm'); 
        if(allowMainBgm && bgm && bgm.paused) {
            bgm.play().catch(e=>{}); 
        }
    }
    
    function stopAllMusic() {
        stopAudio('bgm'); stopAudio('claw-bgm'); stopAudio('mole-bgm'); stopAudio('slide-bgm'); stopAudio('piano2');
    }

    function initPhone(phase) {
        const p=document.getElementById('phone-overlay'); const c=document.getElementById('phone-messages'); const f=document.getElementById('phone-footer'); const h=document.getElementById('phone-header');
        p.style.display='flex'; f.innerHTML="";
        
        const add=(t,m)=>{ 
            h.innerText="æ —å­10.26"; 
            const r=document.createElement('div'); r.className="msg-row"+(m?" me":""); 
            const avatarHtml = m ? "" : `<img src="lizi_avatar.png" class="avatar-img" onerror="this.style.display='none'">`;
            r.innerHTML=avatarHtml+`<div class="bubble">${t}</div>`; 
            c.appendChild(r); c.scrollTop=c.scrollHeight; 
        }
        
        const type=(cb,d)=>{ h.innerText="æ­£åœ¨è¾“å…¥..."; setTimeout(cb,d); }
        if(phase===1) {
            setTimeout(()=>type(()=>add("å¿«é†’é†’ï¼Œå°å®ï¼"),1500),500); setTimeout(()=>type(()=>add("ä¸‰ç‚¹åŠäº†ï¼Œæˆ‘ä»¬ä»Šå¤©è¦å‚åŠ æ¸¸æˆå…çš„æ´»åŠ¨ï¼"),1500),2500);
            setTimeout(()=>{ const b=document.createElement('div'); b.className="pixel-btn"; b.innerText="å•Šå•Šå•Šå•Šå•Šå•Šæˆ‘ç¡è¿‡å¤´äº†ï¼"; b.onclick=()=>{ add("å•Šå•Šå•Šå•Šå•Šå•Šæˆ‘ç¡è¿‡å¤´äº†ï¼",1); tryPlayBgm(); f.innerHTML=""; setTimeout(()=>type(()=>add("æ²¡å…³ç³»ï¼Œæ¥å¾—åŠï¼"),1500),500); setTimeout(()=>type(()=>add("å°ç‹—å’Œä½ åœ¨ä¸€èµ·å—ï¼Ÿæˆ‘æ‰¾äº†ä¸€ä¸Šåˆæ‰¾ä¸åˆ°å®ƒï¼"),1500),2500); setTimeout(()=>{ const b2=document.createElement('div'); b2.className="pixel-btn start"; b2.innerText="å…³é—­æ‰‹æœº"; b2.onclick=()=>{ p.style.display='none'; canvas.focus(); gameState="PLAY"; document.getElementById('task-bar').style.display='block'; document.getElementById('task-bar').innerText="ä»»åŠ¡ï¼šè¯·æŒ‰ã€é¡ºæ—¶é’ˆã€‘æ–¹å‘æ’æŸ¥å®¶å…·å¯»æ‰¾å°ç‹—"; document.getElementById('interact-hint').style.display='block'; }; f.appendChild(b2); }, 4500); } ; f.appendChild(b); },4500);
        } else {
            const b=document.createElement('div'); b.className="pixel-btn"; b.innerText="æ‰¾åˆ°å®ƒäº†ï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆå¸¦ç‹—å»æ¸¸æˆå…ï¼Ÿ";
            b.onclick=()=>{ add("æ‰¾åˆ°å®ƒäº†ï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆå¸¦ç‹—å»æ¸¸æˆå…ï¼Ÿ",1); f.innerHTML=""; setTimeout(()=>type(()=>add("å¯çˆ±å°±æ˜¯æœ‰ç”¨ï¼Œç›¸ä¿¡æˆ‘ï¼",0),1000),500); setTimeout(()=>{ const b2=document.createElement('div'); b2.className="pixel-btn start"; b2.innerText="å‡ºå‘ >"; b2.onclick = () => { p.style.display='none'; canvas.focus(); gameState="PLAY"; flags.phonePhase=2; document.getElementById('task-bar').innerText="ä»»åŠ¡ï¼šå‰å¾€æ¸¸æˆå…"; }; f.appendChild(b2); }, 2000); }
            f.appendChild(b);
        }
    }

    let safeCode="", safeFails=0;
    function initSafe() { document.getElementById('safe-ui').style.display='flex'; document.getElementById('safe-pad').innerHTML=""; for(let i=1;i<=9;i++) mkKey(i); mkKey(0); updateSafe(); }
    function mkKey(n) { const k=document.createElement('div'); k.className="safe-btn"; k.innerText=n; k.onclick=()=>{if(safeCode.length<4)safeCode+=n;updateSafe();if(safeCode.length===4)checkSafe();}; document.getElementById('safe-pad').appendChild(k); }
    function updateSafe() { document.getElementById('safe-screen').innerText=safeCode.padEnd(4,'-'); }
    function closeSafe() { document.getElementById('safe-ui').style.display='none'; gameState="PLAY"; }
    function checkSafe() { 
        if(safeCode==="1128") { 
            closeSafe(); 
            flags.dogFound=true; flags.dogJoined=true; dog.visible=true; 
            playAudio('dog-bark-sfx'); 
            tryPlayBgm();
            startDialog(dialogs.dog_found); 
        } else { 
            safeCode=""; updateSafe(); safeFails++; 
            if(safeFails>=3) alert("æç¤ºï¼šä½ çš„ç”Ÿæ—¥æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ"); else alert("å¯†ç é”™è¯¯"); 
        } 
    }

    const clawGame = {
        score: 0, clawX: 20, clawDir: 1, 
        clawSpeed: 3, 
        animId: null, isDropping: false, dollsStopped: false, dolls: [],
        
        init: function() {
            gameState = "MINIGAME"; this.score = 0; this.clawX = 20; this.clawDir = 1; this.isDropping = false; this.dollsStopped = false;
            document.getElementById('claw-score').innerText = "0"; document.getElementById('claw-machine').style.display = 'flex';
            
            document.getElementById('bgm').pause();
            playAudio('claw-bgm');
            this.spawnDolls(); this.loop();
        },
        spawnDolls: function() {
            const container = document.getElementById('dolls-container'); container.innerHTML = ""; this.dolls = [];
            const types = ["ğŸ¦Š","ğŸ»","ğŸ°","ğŸ¶","ğŸ¼"];
            for(let i=0; i<5; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                const finalType = (i===2 && !this.dolls.some(d=>d.t==="ğŸ¦Š")) ? "ğŸ¦Š" : type;
                const d = document.createElement('div'); d.className = "doll"; d.innerText = finalType;
                const x = 50 + i * 80 + (Math.random()*20 - 10); d.style.left = x + "px";
                container.appendChild(d); 
                const spd = 2 + Math.random() * 2.5;
                this.dolls.push({el: d, x: x, t: finalType, dir: Math.random()>0.5?1:-1, speed: spd});
            }
        },
        loop: function() {
            if(gameState !== "MINIGAME") return;
            if(!this.isDropping) {
                this.clawX += this.clawSpeed * this.clawDir;
                if(this.clawX > 440 || this.clawX < 0) this.clawDir *= -1;
                document.getElementById('claw-assembly').style.left = (this.clawX + 20) + "px"; 
            }
            
            if(!this.dollsStopped) {
                this.dolls.forEach(d => {
                    if(Math.random() < 0.05) d.dir *= -1; 
                    d.x += d.dir * d.speed; 
                    if(d.x < 10) d.dir = 1; if(d.x > 440) d.dir = -1; d.el.style.left = d.x + "px";
                });
            }
            this.animId = requestAnimationFrame(()=>this.loop());
        },
        drop: function() {
            if(this.isDropping) return; 
            this.isDropping = true;
            this.dollsStopped = true; 
            playAudio('claw-drop-sfx');
            const arm = document.getElementById('claw-assembly'); arm.style.height = "380px";
            setTimeout(() => { this.checkHit(); arm.style.height = "100px"; setTimeout(() => { this.isDropping = false; this.dollsStopped = false; }, 500); }, 500);
        },
        checkHit: function() {
            const clawCenter = this.clawX + 20; 
            
            // V57 Smart Scheme
            let bestDoll = null;
            let minDist = Infinity;
            const range = 20;

            for(let i=0; i<this.dolls.length; i++) {
                const d = this.dolls[i];
                const dist = Math.abs(clawCenter - (d.x + 25));
                if(dist < range && dist < minDist) {
                    minDist = dist;
                    bestDoll = d;
                }
            }

            if (bestDoll) {
                if(bestDoll.t === "ğŸ¦Š") { this.score++; document.getElementById('claw-score').innerText = this.score; alert("æŠ“åˆ°äº†ç‹ç‹¸ï¼"); } 
                else if(bestDoll.t === "ğŸ»") { alert("ç³»ç»Ÿï¼šå¥½æ²‰ä¸€åª...æ ¹æœ¬æŠ“ä¸èµ·æ¥..."); }
                else if(bestDoll.t === "ğŸ°") { alert("ç³»ç»Ÿï¼šå…”å­è¹¬äº†ä¸€è„šçˆªå­ï¼Œæºœäº†ï¼"); }
                else if(bestDoll.t === "ğŸ¶") { alert("å°ç‹—ï¼šæ±ªï¼Ÿï¼ˆé˜Ÿå‹ä½ ä¹ŸæŠ“ï¼Ÿï¼‰"); }
                else if(bestDoll.t === "ğŸ¼") { alert("ç³»ç»Ÿï¼šè¿™æ˜¯å›½å®ï¼å¿«æ”¾çˆªï¼"); }
                if(this.score >= 3) this.win(); else this.spawnDolls();
            } else {
                // Missed
            }
        },
        win: function() {
            cancelAnimationFrame(this.animId); document.getElementById('claw-machine').style.display = 'none';
            stopAudio('claw-bgm'); 
            tryPlayBgm(); 
            gameState = "PLAY"; flags.clawPassed = true; flags.moleUnlocked = true; startDialog(dialogs.claw_win);
        },
        close: function() { 
            cancelAnimationFrame(this.animId); document.getElementById('claw-machine').style.display = 'none'; 
            stopAudio('claw-bgm'); 
            tryPlayBgm(); 
            gameState = "PLAY"; 
        }
    };

    const moleGame = {
        score: 0, time: 30, timerId: null, spawnId: null, speed: 1000,
        open: function() { 
            gameState = "MINIGAME"; 
            document.getElementById('mole-machine').style.display = 'flex'; 
            document.getElementById('mole-start-overlay').style.display = 'flex';
            document.getElementById('bgm').pause();
            playAudio('mole-bgm'); 
        },
        start: function() {
            this.score = 0; this.time = 30; this.speed = 1000;
            document.getElementById('mole-score').innerText = 0; document.getElementById('mole-time').innerText = 30;
            document.getElementById('mole-start-overlay').style.display = 'none';
            this.gameLoop();
            this.timerId = setInterval(() => { this.time--; document.getElementById('mole-time').innerText = this.time; if(this.time <= 0) this.end(false); }, 1000);
        },
        gameLoop: function() {
            if(this.time <= 0) return;
            let stayTime = 800; let nextDelay = 1000; let count = 1;
            if (this.score >= 7) { stayTime = 400; nextDelay = 400; count = 2; } else if (this.score >= 3) { stayTime = 500; nextDelay = 600; }
            for(let i=0; i<count; i++) this.spawnMole(stayTime);
            this.spawnId = setTimeout(() => this.gameLoop(), nextDelay);
        },
        spawnMole: function(stayTime) {
            const holeIdx = Math.floor(Math.random() * 9); const hole = document.getElementById('hole' + holeIdx);
            if(hole.querySelector('.mole-sprite')) return;
            const isYellow = Math.random() < 0.2; const typeClass = isYellow ? 'mole-yellow' : 'mole-orange'; const icon = isYellow ? 'ğŸŸ¡' : 'ğŸŸ ';
            const mole = document.createElement('div'); mole.className = `mole-sprite ${typeClass}`; mole.innerText = icon;
            mole.onmousedown = (e) => {
                e.stopPropagation();
                if(isYellow) { 
                    this.score = Math.max(0, this.score - 1); mole.innerText = "âŒ"; 
                } else { 
                    this.score++; mole.innerText = "ğŸ’¥"; 
                    playAudio('hit-sfx'); 
                }
                document.getElementById('mole-score').innerText = this.score;
                setTimeout(() => { if(mole.parentNode) mole.parentNode.removeChild(mole); }, 200);
                if(this.score >= 10) this.end(true);
            };
            hole.appendChild(mole); setTimeout(() => mole.classList.add('up'), 50);
            setTimeout(() => { if(mole.parentNode) { mole.classList.remove('up'); setTimeout(() => { if(mole.parentNode) mole.parentNode.removeChild(mole); }, 200); } }, stayTime);
        },
        end: function(win) {
            clearInterval(this.timerId); clearTimeout(this.spawnId);
            document.querySelectorAll('.mole-sprite').forEach(e => e.remove());
            if(win) { flags.molePassed = true; this.close(); showPrize(); } 
            else { alert("æ—¶é—´åˆ°äº†ï¼è¿˜å·®ä¸€ç‚¹ï¼Œå†è¯•ä¸€æ¬¡å§ï¼"); document.getElementById('mole-start-overlay').style.display = 'flex'; }
        },
        close: function() { 
            clearInterval(this.timerId); clearTimeout(this.spawnId); 
            document.getElementById('mole-machine').style.display = 'none'; 
            stopAudio('mole-bgm'); 
            tryPlayBgm(); 
            gameState = "PLAY"; 
        }
    };

    function showPrize() { 
        gameState = "PRIZE"; 
        document.getElementById('prize-overlay').style.display = 'flex'; 
        allowMainBgm = false; 
        document.getElementById('bgm').pause(); 
        playAudio('win-sfx'); 
        
        document.getElementById('win-sfx').onended = function() {
            allowMainBgm = true;
            tryPlayBgm();
        };
    }
    
    function hidePrize() { 
        if(gameState !== "PRIZE") return; 
        document.getElementById('prize-overlay').style.display = 'none'; 
        allowMainBgm = true;
        tryPlayBgm();
        gameState = "DIALOG"; flags.finalPhase = true; startDialog(dialogs.finale_1); 
    }
    function startFinaleSequence() { const yexiu = scenes.HALL.objects.find(o=>o.name==="yexiu"); yexiu.visible = true; yexiu.color = "#808080"; startDialog(dialogs.finale_2); }
    function dogMoveToYeXiu() { flags.dogFollowsYeXiu = true; startDialog(dialogs.finale_3_tape); }

    let slideIdx = 0;
    function playSlideshow() { 
        gameState = "SLIDE"; document.getElementById('slideshow-overlay').style.display = 'flex'; 
        slideIdx = 0; 
        updateSlide(0);
        
        allowMainBgm = false;
        document.getElementById('bgm').pause(); 
        playAudio('slide-bgm'); 
        
        const sBgm = document.getElementById('slide-bgm');
        sBgm.onended = () => { finishSlideshow(); };
    }
    
    function updateSlide(idx) {
        if(idx < 0) idx = 0;
        if(idx >= slideData.length) idx = slideData.length - 1;
        slideIdx = idx;
        
        const s = slideData[slideIdx];
        const imgDom = document.getElementById('slide-img-dom'); 
        const txtFallback = document.getElementById('slide-text-fallback'); 
        imgDom.style.display = 'block'; txtFallback.style.display = 'none';
        imgDom.src = s.img; 
    }
    
    function changeSlide(dir) {
        updateSlide(slideIdx + dir);
    }
    
    function finishSlideshow() {
        document.getElementById('slideshow-overlay').style.display = 'none'; 
        stopAudio('slide-bgm');
        showInput();
    }

    function showInput() { gameState = "INPUT"; document.getElementById('input-overlay').style.display = 'flex'; document.getElementById('user-input').focus(); }
    
    // V59: æäº¤è¾“å…¥ -> æ˜¾ç¤ºä¿¡ä»¶ (ä¸ç›´æ¥å¤§ç»“å±€)
    function submitFinalMsg() { 
        const txt = document.getElementById('user-input').value || "...";
        document.getElementById('input-overlay').style.display = 'none'; 
        
        // ä¿å­˜ç”¨æˆ·è¾“å…¥ï¼Œå‡†å¤‡ä¸€ä¼šå„¿ç”¨
        const userLine = {n: "å°è‘µ", t: txt};
        if(dialogs.finale_4_happy[0].n !== "å°è‘µ") {
            dialogs.finale_4_happy.unshift(userLine);
        }
        
        // è§¦å‘è¯»ä¿¡ç¯èŠ‚
        showLetter();
    }
    
    // V59: è¯»ä¿¡é€»è¾‘
    function showLetter() {
        gameState = "LETTER";
        document.getElementById('letter-overlay').style.display = 'flex';
        allowMainBgm = false;
        stopAllMusic();
        playAudio('piano2'); // æ’­æ”¾è¯»ä¿¡BGM
    }
    
    // V59: å…³é—­ä¿¡ä»¶ -> è·å¾—é“å…· -> è§¦å‘å¤§ç»“å±€
    function closeLetter() {
        document.getElementById('letter-overlay').style.display = 'none';
        stopAudio('piano2');
        
        // æ’å…¥è·å¾—é“å…·çš„ç³»ç»Ÿæç¤º
        const items = [
            {n:"ç³»ç»Ÿ", t:"è·å¾— [å¶ä¿®çš„è¿åŠ¨èƒŒåŒ…] x1"},
            {n:"ç³»ç»Ÿ", t:"è·å¾— [å¶ä¿®çš„å®ä¸½æ¥ç›¸æœº] x1"},
            {n:"ç³»ç»Ÿ", t:"è·å¾— [å¶ä¿®çš„æ¯›ç»’ç‹ç‹¸æ‰“åœ°é¼ æœº] x1"},
            {n:"ç³»ç»Ÿ", t:"è·å¾— [å¶ä¿®çš„å¨ƒå¨ƒå‘¨è¾¹] x1"}
        ];
        
        // å°†é“å…·æç¤ºæ’åˆ°å¤§ç»“å±€å¯¹è¯ä¹‹å‰
        // æ³¨æ„é¡ºåºï¼šå…ˆæ˜¾ç¤ºé“å…·ï¼Œå†æ˜¾ç¤ºåˆšæ‰ç”¨æˆ·çš„è¾“å…¥ï¼Œå†æ˜¾ç¤ºå¶ä¿®å›å¤
        dialogs.finale_4_happy = items.concat(dialogs.finale_4_happy);
        
        startDialog(dialogs.finale_4_happy);
    }
    
    function triggerHappyEnding() { 
        gameState = "END"; 
        document.getElementById('bgm-indicator').style.display = 'block'; 
        
        allowMainBgm = false;
        stopAllMusic();
        
        alignCharactersForEnding();
        
        playAudio('firework-sfx');
        startFireworks(); 
        
        const fSfx = document.getElementById('firework-sfx');
        fSfx.onended = () => { 
            alert("æ¸¸æˆç»“æŸï¼ç”Ÿæ—¥å¿«ä¹ï¼"); 
            document.getElementById('end-game-btn').style.display = 'block';
        };
    }
    
    function alignCharactersForEnding() {
        lizi.x = 300; lizi.y = 300; lizi.visible = true;
        player.x = 350; player.y = 300;
        const yexiu = scenes.HALL.objects.find(o => o.name === "yexiu");
        if(yexiu) { yexiu.x = 400; yexiu.y = 300; yexiu.visible = true; }
        dog.x = 450; dog.y = 300; dog.visible = true;
        
        const cake = scenes.HALL.objects.find(o => o.name === "cake");
        if(cake) cake.visible = true;
        
        draw(); 
    }

    const particles = [];
    function startFireworks() {
        document.getElementById('fireworks-canvas').style.display = 'block';
        const ctxF = document.getElementById('fireworks-canvas').getContext('2d');
        // V59: çƒŸèŠ±åŠ å¼º (0.1s)
        setInterval(() => { createFirework(Math.random()*800, Math.random()*400); }, 100);
        function animateF() {
            ctxF.clearRect(0,0,800,600);
            for(let i=0; i<particles.length; i++) {
                const p = particles[i]; p.x += p.vx; p.y += p.vy; p.life--; p.vy += 0.05; ctxF.fillStyle = p.color; ctxF.fillRect(p.x, p.y, 4, 4);
            }
            for(let i=particles.length-1; i>=0; i--) { if(particles[i].life<=0) particles.splice(i,1); }
            requestAnimationFrame(animateF);
        }
        animateF();
    }
    function createFirework(x, y) {
        const colors = ["#f00", "#0f0", "#00f", "#ff0", "#0ff", "#f0f", "#fff"]; const c = colors[Math.floor(Math.random()*colors.length)];
        // V59: ç²’å­åŠ å€ (100)
        for(let i=0; i<100; i++) {
            const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 3 + 1;
            particles.push({ x: x, y: y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, life: 60 + Math.random()*40, color: c });
        }
    }

    const keys={}; window.onkeydown=e=>{ 
        keys[e.key]=true; 
        if(e.code==="Space") { 
            if(gameState==="PRIZE") hidePrize(); else interact(); 
        } 
    }; window.onkeyup=e=>keys[e.key]=false;
    
    function loop() {
        if(gameState==="PLAY" || gameState==="DIALOG") { 
            if(gameState==="PLAY") {
                if(keys['w']||keys['ArrowUp'])player.y-=player.speed; if(keys['s']||keys['ArrowDown'])player.y+=player.speed;
                if(keys['a']||keys['ArrowLeft'])player.x-=player.speed; if(keys['d']||keys['ArrowRight'])player.x+=player.speed;
                if(player.x<0)player.x=0; if(player.y<0)player.y=0; if(player.x>768)player.x=768; if(player.y>552)player.y=552;
                if(keys['w']||keys['s']||keys['a']||keys['d']) tryPlayBgm();
            }
            if(flags.dogJoined) {
                let targetX = player.x, targetY = player.y;
                if(flags.dogFollowsYeXiu) { const yexiu = scenes.HALL.objects.find(o=>o.name==="yexiu"); targetX = yexiu.x; targetY = yexiu.y; }
                dog.x += (targetX - dog.x)*0.1; dog.y += (targetY+40 - dog.y)*0.1;
            }
            if(flags.hallMeetLizi) { lizi.x+=(dog.x-lizi.x)*0.1; lizi.y+=(dog.y+40-lizi.y)*0.1; }
        }
        draw(); requestAnimationFrame(loop);
    }
    
    function draw() {
        ctx.fillStyle = scenes[currentScene].bg || "#000"; 
        ctx.fillRect(0, 0, 800, 600);

        let bgImg = null;
        if(currentScene === "BEDROOM") bgImg = imgCache['bg_bedroom.png'];
        if(currentScene === "HALL") bgImg = imgCache['bg_hall.png'];

        if(bgImg) {
             const pat = ctx.createPattern(bgImg, 'repeat');
             ctx.fillStyle = pat;
             ctx.fillRect(0, 0, 800, 600);
        }

        scenes[currentScene].objects.forEach(o => {
            if(o.name==="lizi_npc" && flags.hallMeetLizi) return;
            if(o.visible === false) return; 
            
            drawSprite(o.name, o.x, o.y, o.w, o.h, o.color);
            
            if(o.label) {
                ctx.fillStyle="white"; ctx.font="12px Arial"; ctx.fillText(o.label, o.x, o.y-5);
            }
        });
        
        if(lizi.visible) drawSprite('lizi',lizi.x,lizi.y,lizi.w,lizi.h,lizi.color);
        if(dog.visible) drawSprite('dog',dog.x,dog.y,dog.w,dog.h,dog.color);
        drawSprite('player',player.x,player.y,player.w,player.h,player.color);
    }
    
    function interact() {
        if(!flags.hasInteracted) {
            flags.hasInteracted = true;
            document.getElementById('interact-hint').style.display = 'none';
            tryPlayBgm(); 
        }

        if(gameState==="DIALOG") { nextDialog(); return; }
        if(gameState!=="PLAY") return;
        let t = scenes[currentScene].objects.find(o => Math.abs(player.x+16-(o.x+o.w/2))<60 && Math.abs(player.y+24-(o.y+o.h/2))<60);
        if(t) {
            if(currentScene==="BEDROOM" && !flags.dogFound && t.name!=="safe" && t.name!=="door") {
                if(t.name==="desk") startDialog(dialogs.desk_full); else if(t.noDog) startDialog([{n:"å°è‘µ",t:t.text}, {n:"å°è‘µ",t:t.noDog}]); else if(t.text) startDialog([{n:"å°è‘µ",t:t.text}, {n:"å°è‘µ",t:"â€¦â€¦è¿™é‡Œä¹Ÿæ²¡æœ‰ã€‚"}]); return;
            }
            if(t.name==="desk") { startDialog(dialogs.desk_full); return; }
            if(t.text && !t.name.startsWith("machine") && t.name!=="dance" && t.name!=="basket" && t.name!=="coin" && t.name!=="arcade" && t.name!=="gun") { startDialog([{n:"å°è‘µ",t:t.text}]); return; }
            if(["dance","basket","coin","arcade","gun"].includes(t.name)) { startDialog([{n:"å°è‘µ",t:t.text}]); return; }
            if(t.name==="safe") initSafe();
            else if(t.name==="door") {
                if(currentScene==="BEDROOM") { if(!flags.dogJoined) startDialog(dialogs.door_locked); else if(flags.phonePhase<2) initPhone(2); else transition("HALL", 350, 500); } else transition("BEDROOM", 350, 500);
            }
            else if(t.name==="lizi_npc") { flags.hallMeetLizi=true; lizi.visible=true; startDialog(dialogs.hall_meet); }
            else if(t.name==="clerk" || t.name==="counter") interactClerk(); 
            else if(t.name==="claw") interactClaw(); else if(t.name==="mole") interactMole();
            else if(t.name==="yexiu") startDialog([{n:"å¶ä¿®",t:"å“¥çš„ä¼ è¯´ï¼Œè¿˜åœ¨ç»§ç»­ã€‚"}]);
        }
    }
    function transition(to, x, y) {
        document.getElementById('transition-overlay').style.display='flex';
        if(to === "HALL") document.getElementById('task-bar').style.display='none';
        setTimeout(()=>{
            currentScene=to; player.x=x; player.y=y;
            if(flags.dogJoined){dog.x=x+40;dog.y=y;} if(flags.hallMeetLizi){lizi.x=x-40;lizi.y=y;}
            document.getElementById('transition-overlay').style.display='none';
        }, 1500);
    }
    function startDialog(list) { dialogQueue=[...list]; gameState="DIALOG"; document.getElementById('dialog-box').classList.remove('hidden'); nextDialog(); }
    function nextDialog() {
        if(dialogQueue.length===0) {
            document.getElementById('dialog-box').classList.add('hidden'); gameState="PLAY";
            const t=document.getElementById('dialog-text').innerText;
            if(t.includes("æ‰‹æœº")) initPhone(2);
            if(t.includes("é—®é¢˜æ˜¯ä»€ä¹ˆ")) { flags.coinCount=1; startQuiz(0); }
            if(t.includes("å†ç»™ä½ ä»¬ä¸€æ¬¡æœºä¼š")) startQuiz(2);
            if(t.includes("ç’ç€ä½ ")) startFinaleSequence(); if(t.includes("å°ç‹—ï¼Œè¿‡æ¥")) dogMoveToYeXiu(); if(t.includes("æ¥è¿‡å½•åƒå¸¦")) playSlideshow(); if(t.includes("ç”Ÿæ—¥å¿«ä¹")) triggerHappyEnding();
            return;
        }
        const l=dialogQueue.shift(); document.getElementById('dialog-name').innerText=l.n; document.getElementById('dialog-text').innerText=l.t;
    }
    function interactClerk() { if(!flags.hallMeetLizi) { startDialog([{n:"ç³»ç»Ÿ",t:"å…ˆæ‰¾å°æ —å­ï¼"}]); return; } if(flags.coinCount===0) startDialog(dialogs.clerk_buy); else if(flags.coinCount===1) startQuiz(0); else startDialog([{n:"åº—å‘˜",t:"å¿«å»ç©å§ï¼"}]); }
    function interactClaw() { if(!flags.hallMeetLizi) { startDialog([{n:"ç³»ç»Ÿ",t:"å…ˆæ‰¾å°æ —å­ï¼"}]); return; } if(flags.coinCount<3) { startDialog([{n:"ç³»ç»Ÿ",t:"æ²¡å¸ï¼å»æ‰¾åº—å‘˜æ¢ã€‚"}]); return; } if(flags.clawPassed) { startDialog([{n:"ç³»ç»Ÿ",t:"å¨ƒå¨ƒå·²ç»æŠ“å¤Ÿå•¦ï¼å»ç©æ‰“åœ°é¼ å§ã€‚"}]); return; } clawGame.init(); }
    function interactMole() { if(!flags.moleUnlocked) { startDialog([{n:"ç³»ç»Ÿ",t:"ã€é”å®šã€‘è¯·å…ˆé€šè¿‡æŠ“å¨ƒå¨ƒæœºï¼Œèµ¢å–æŒ‘æˆ˜èµ„æ ¼ï¼"}]); return; } if(flags.molePassed) { startDialog([{n:"ç³»ç»Ÿ",t:"è¿™å°æœºå™¨çš„è®°å½•å·²ç»æ˜¯ä½ çš„äº†ï¼"}]); return; } moleGame.open(); }
    function startQuiz(step) {
        gameState="QUIZ"; const ui=document.getElementById('quiz-ui'); ui.style.display='flex'; const qt=document.getElementById('quiz-question'); const qo=document.getElementById('quiz-options'); qo.innerHTML="";
        if(step===0) { document.getElementById('quiz-title').innerText="Q1 å°è‘µ"; qt.innerText="å¼ ä½³ä¹æ˜¯______ï¼Ÿ"; [{t:"A. å±±ä¸œäºº"},{t:"B. æªç‚®å¸ˆ"},{t:"C. äº‘å—äºº",ok:true},{t:"D. å† å†›",egg:true}].forEach(o=>mkQBtn(o,0)); } 
        else if(step===1) { document.getElementById('quiz-title').innerText="Q2 å°æ —å­"; qt.innerText="å¶ä¿®æ˜¯______ï¼Ÿ"; ["A. æ²³å—äºº","B. æ•£äºº","C. è”ç›Ÿå¥³ç¥","D. æ²³åŒ—äºº"].forEach(t=>{ const b=document.createElement('div'); b.className='quiz-option-btn'; b.innerText=t; qo.appendChild(b); }); setTimeout(()=>{ ui.style.display='none'; startDialog(dialogs.lizi_quiz_wrong); }, 3000); } 
        else { document.getElementById('quiz-title').innerText="Q2 è¡¥ç­”"; qt.innerText="å¶ä¿®æ˜¯______ï¼Ÿ"; [{t:"A. æ²³å—äºº"},{t:"B. æ•£äºº",ok:true},{t:"C. è”ç›Ÿå¥³ç¥"},{t:"D. æ²³åŒ—äºº"}].forEach(o=>mkQBtn(o,2)); }
    }
    function mkQBtn(o, step) { const b=document.createElement('div'); b.className="quiz-option-btn"; b.innerText=o.t; b.onclick=()=>{ if(o.egg) { alert("åº—å‘˜ï¼šå€Ÿä½ å‰è¨€ï¼ç®—è¿‡ï¼"); startQuiz(1); } else if(o.ok) { if(step===0) startQuiz(1); else { document.getElementById('quiz-ui').style.display='none'; flags.coinCount=3; startDialog(dialogs.quiz_pass); } } else alert("é”™ï¼"); }; document.getElementById('quiz-options').appendChild(b); }

    preloadAssets(); initPhone(1); loop();
</script>
</body>
</html>